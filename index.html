<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integra + | Gestão V46 (Estável)</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #0f4c81; --primary-soft: #e6f0fa; --bg-body: #f8fafc;
            --white: #ffffff; --text-main: #0f172a; --text-light: #64748b;
            --border-light: #e2e8f0; --danger: #ef4444; --warning: #f59e0b;
            --status-done: #059669; --status-done-bg: #d1fae5;
            --status-ontime: #15803d; --status-ontime-bg: #dcfce7;
            --status-todo: #475569; --status-todo-bg: #f1f5f9;
            --brand-cyan: #00d2d3;
            --prio-low: #3b82f6; --prio-med: #f59e0b; --prio-high: #ef4444;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); margin: 0; padding-bottom: 80px; color: var(--text-main); overflow-x: hidden; }
        * { box-sizing: border-box; outline: none; }

        /* LOADING OVERLAY */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; pointer-events: all; }
        #loading-overlay.hidden { opacity: 0; pointer-events: none; }
        
        .spinner { width: 50px; height: 50px; border: 5px solid var(--primary-soft); border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        header { background: var(--white); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; gap: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); position: sticky; top: 0; z-index: 50; border-bottom: 1px solid var(--border-light); }
        .logo-area { cursor: pointer; user-select: none; display: flex; align-items: center; }
        .logo-area h1 { margin: 0; font-family: 'Montserrat', sans-serif; font-size: 1.8rem; font-weight: 900; letter-spacing: -1px; text-transform: uppercase; display: flex; align-items: center; gap: 2px; }
        .brand-text { background: linear-gradient(135deg, #0f4c81 0%, #2980b9 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; transition: all 0.3s ease; }
        @keyframes spinIn { 0% { opacity: 0; transform: scale(0) rotate(-720deg); } 100% { opacity: 1; transform: scale(1) rotate(0deg); } }
        @keyframes spinCycle { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .brand-plus { color: var(--brand-cyan); font-size: 2.2rem; line-height: 0; margin-top: -6px; text-shadow: 0 0 15px rgba(0, 210, 211, 0.2); display: inline-block; animation: spinIn 1.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .logo-area:hover .brand-plus { animation: spinCycle 1s linear infinite; }
        .logo-area:hover .brand-text { letter-spacing: 2px; }

        .header-actions { display: flex; align-items: center; gap: 15px; }
        .filter-pills { display: flex; gap: 8px; background: #f1f5f9; padding: 4px; border-radius: 50px; }
        .filter-btn { border: none; background: transparent; padding: 8px 16px; border-radius: 40px; font-size: 0.8rem; font-weight: 600; color: var(--text-light); cursor: pointer; transition: all 0.3s; white-space: nowrap; }
        .filter-btn:hover { color: var(--primary); background: rgba(255,255,255,0.5); }
        .filter-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: 700; }
        .btn-toggle-stats { background: var(--bg-body); color: var(--text-light); border: 1px solid var(--border-light); padding: 10px 15px; border-radius: 50px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-toggle-stats:hover, .btn-toggle-stats.active { background: var(--primary-soft); color: var(--primary); border-color: var(--primary-soft); }
        
        .search-wrapper { position: relative; height: 40px; display: flex; align-items: center; }
        .search-input { width: 40px; height: 40px; border-radius: 50px; border: 1px solid transparent; background: transparent; padding: 0 10px 0 40px; font-size: 0.95rem; cursor: pointer; transition: all 0.4s; opacity: 0; position: relative; z-index: 2; }
        .search-icon-bg { position: absolute; left: 0; top: 0; width: 40px; height: 40px; background: var(--bg-body); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-light); pointer-events: none; transition: 0.3s; }
        .search-wrapper:hover .search-input, .search-input:focus, .search-input:not(:placeholder-shown) { width: 200px; background: white; border-color: var(--border-light); opacity: 1; cursor: text; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .search-input:focus ~ .search-icon-bg { color: var(--primary); }
        .btn-main-add { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 50px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; white-space: nowrap; box-shadow: 0 4px 10px rgba(15, 76, 129, 0.2); }
        .btn-main-add:hover { transform: translateY(-2px); background: #0a3d6a; }

        .stats-panel { max-height: 0; overflow: hidden; transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1); background: #fff; border-bottom: 1px solid transparent; }
        .stats-panel.open { max-height: 1000px; border-bottom-color: var(--border-light); }
        .dashboard-grid { max-width: 1200px; margin: 0 auto; padding: 30px 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .chart-box { background: var(--bg-body); border-radius: 16px; padding: 20px; border: 1px solid var(--border-light); position: relative; display: flex; flex-direction: column; max-height: 400px; }
        .span-2 { grid-column: span 2; }
        .span-4 { grid-column: 1 / -1; }
        .chart-title { font-size: 0.8rem; font-weight: 800; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; flex-shrink: 0; }
        .chart-container-fixed { position: relative; height: 200px; width: 100%; display: flex; justify-content: center; }
        .chart-scroll-wrapper { flex-grow: 1; overflow-y: auto; overflow-x: hidden; position: relative; padding-right: 10px; }
        .chart-dynamic-height { position: relative; width: 100%; }

        .tabs-container { max-width: 1200px; margin: 20px auto 0 auto; padding: 0 20px; display: flex; gap: 20px; border-bottom: 2px solid var(--border-light); }
        .tab-btn { padding: 10px 20px; font-size: 1rem; font-weight: 600; color: var(--text-light); cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; margin-bottom: -2px; }
        .tab-btn:hover { color: var(--primary); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-count { background: #e2e8f0; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 8px; color: var(--text-main); }
        .tab-btn.active .tab-count { background: var(--primary); color: white; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; max-width: 1200px; margin: 30px auto; padding: 0 20px; min-height: 300px; align-items: start; }
        .empty-state { grid-column: 1 / -1; text-align: center; padding: 50px; color: var(--text-light); font-style: italic; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: white; border-radius: 16px; padding: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 2px solid transparent; transition: all 0.3s; position: relative; cursor: pointer; display:flex; flex-direction: column; animation: fadeInUp 0.4s ease-out backwards; overflow: hidden; height: auto; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); border-color: var(--primary-soft); }
        .card.is-late { border-color: var(--danger); background: #fffbfb; } 
        .card.is-concluded { border-color: var(--status-done); background: var(--status-done-bg); }
        .card-main { padding: 24px 24px 15px 24px; display:flex; flex-direction:column; }
        .card-footer { padding: 12px 24px; background: rgba(241, 245, 249, 0.5); border-top: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-top: 5px; }
        .card-header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .prio-badge { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 4px 10px; border-radius: 20px; color: white; display: flex; align-items: center; gap: 4px; }
        .p-alta { background: var(--prio-high); box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3); }
        .p-media { background: var(--prio-med); }
        .p-baixa { background: var(--prio-low); }
        .status-text { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: var(--text-light); display: flex; align-items: center; gap: 5px; }
        .dot-status { width: 8px; height: 8px; border-radius: 50%; }
        .st-pendente .dot-status { background: var(--status-todo); }
        .st-andamento .dot-status { background: var(--warning); }
        .st-concluido .dot-status { background: var(--status-done); }
        .card h3 { margin: 0 0 8px 0; font-size: 1.2rem; font-weight: 700; color: var(--text-main); line-height: 1.35; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-origin-row { font-size: 0.85rem; color: var(--text-light); margin-bottom: 15px; display: flex; align-items: center; gap: 6px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .origin-text-content { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-meta { display: flex; gap: 10px; font-size: 0.75rem; color: var(--text-light); font-weight: 600; flex-wrap: wrap; align-items: center; margin-top:auto; }
        .meta-item { display: flex; align-items: center; gap: 5px; }
        .date-pill { padding: 3px 10px; border-radius: 6px; font-size: 0.65rem; text-transform: uppercase; font-weight: 800; margin-left: 5px; display:inline-flex; align-items:center; }
        .date-pill.late { background: var(--danger); color: white; }
        .date-pill.ontime { background: var(--status-ontime-bg); color: var(--status-ontime); border: 1px solid rgba(21, 128, 61, 0.2); }
        .date-pill.nodate { background: #f1f5f9; color: #94a3b8; border: 1px solid #e2e8f0; } 
        .resp-container { display: flex; flex-wrap: wrap; gap: 5px; }
        .resp-tag { background: white; color: var(--text-light); border: 1px solid var(--border-light); padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; }
        .unit-clean { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 20, 40, 0.4); backdrop-filter: blur(5px); z-index: 100; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.active { opacity: 1; }
        .modal-wide { background: white; width: 1000px; max-width: 95%; height: 90vh; border-radius: 24px; display: flex; flex-direction: column; box-shadow: 0 25px 50px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.3s; overflow: hidden; }
        .modal-overlay.active .modal-wide { transform: scale(1); }
        .modal-top { padding: 20px 40px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .title-input { font-family: 'Montserrat', sans-serif; font-size: 1.6rem; border: none; border-bottom: 2px solid transparent; font-weight: 800; color: var(--text-main); width: 80%; background: transparent; padding: 8px 0; transition: all 0.3s ease; }
        .title-input:focus { border-bottom-color: var(--primary); padding-left: 10px; }
        .close-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border-light); background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .close-btn:hover { background: #f7f7f7; color: var(--danger); }
        .modal-body { display: grid; grid-template-columns: 1fr 1.5fr; flex: 1; overflow: hidden; }
        .col-left { padding: 40px; background: #fafbfc; border-right: 1px solid var(--border-light); overflow-y: auto; display: flex; flex-direction: column; }
        .col-right { padding: 40px; background: #fff; overflow-y: auto; display: flex; flex-direction: column; }
        .section-label { text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; color: var(--text-light); font-weight: 700; margin-bottom: 10px; display: block; }
        .styled-textarea { width: 100%; border: 2px solid var(--border-light); border-radius: 12px; padding: 18px; font-family: inherit; font-size: 1rem; resize: vertical; background: white; transition: 0.3s; min-height: 150px; flex-grow: 1; }
        .styled-textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-soft); }
        .styled-input { width: 100%; border: 2px solid var(--border-light); padding: 12px; border-radius: 10px; font-size: 0.95rem; background: white; }
        .meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .date-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .date-card { background: white; border: 1px solid var(--border-light); border-radius: 12px; padding: 5px 10px; display: flex; flex-direction: column; transition: all 0.2s; }
        .date-card:focus-within { border-color: var(--primary); box-shadow: 0 4px 12px rgba(15, 76, 129, 0.1); transform: translateY(-2px); }
        .date-card label { font-size: 0.7rem; color: var(--text-light); font-weight: 700; text-transform: uppercase; margin-bottom: 2px; }
        .date-input-clean { border: none; outline: none; background: transparent; font-family: 'Inter'; font-weight: 600; font-size: 0.95rem; color: var(--text-main); width: 100%; padding: 5px 0; cursor: pointer; }
        
        .timeline { margin-top: 20px; padding-left: 30px; position: relative; border-left: 2px solid #e0e7ff; }
        .timeline-item { position: relative; margin-bottom: 35px; transition: transform 0.2s, opacity 0.2s; }
        .timeline-item.dragging { opacity: 0.4; transform: scale(0.98); }
        .timeline-item.dragging .t-bubble { border-color: var(--primary); border-style: dashed; background: #fafafa; box-shadow: none; }
        .timeline-item.drag-over-target .t-bubble { background-color: var(--primary-soft) !important; border-color: var(--primary) !important; transform: scale(1.02) !important; box-shadow: 0 8px 15px rgba(15, 76, 129, 0.1) !important; }
        .timeline.is-dragging-active .t-bubble * { pointer-events: none; }
        .t-dot { position: absolute; left: -37px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: var(--primary); box-shadow: 0 0 0 4px rgba(15, 76, 129, 0.2); transition: all 0.3s; }
        .t-bubble { background: white; padding: 20px; border-radius: 0 14px 14px 14px; border: 1px solid var(--border-light); box-shadow: 0 4px 6px rgba(0,0,0,0.02); position: relative; word-wrap: break-word; overflow-wrap: break-word; cursor: grab; transition: all 0.2s; }
        .t-bubble:hover { box-shadow: 0 10px 25px rgba(15, 76, 129, 0.15); transform: translateY(-4px) scale(1.01); border-color: var(--primary-soft); }
        .t-bubble:active { cursor: grabbing; }
        .t-obs { font-size: 0.9rem; color: var(--text-light); margin-top: 8px; white-space: pre-wrap; line-height: 1.6; border-top: 1px solid #f0f0f0; padding-top: 8px; }
        .t-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; opacity: 0.5; transition: 0.2s; }
        .t-bubble:hover .t-actions { opacity: 1; }
        .t-btn-icon { cursor: pointer; color: #cbd5e0; transition: 0.2s; font-size: 18px; }
        .t-btn-icon:hover { color: var(--primary); transform: scale(1.2); }
        .t-btn-icon.del:hover { color: var(--danger); }
        .add-step-area { margin-top: 20px; background: var(--primary-soft); padding: 20px; border-radius: 16px; border: 1px solid rgba(15,76,129,0.1); }
        .step-obs-area { width: 100%; border: 1px solid #cbd5e0; border-radius: 8px; padding: 10px; font-family: inherit; margin-top: 10px; min-height: 60px; }
        .modal-footer { padding: 20px 40px; border-top: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .status-segmented { display: flex; background: #f1f5f9; padding: 5px; border-radius: 14px; gap: 5px; }
        .seg-btn { padding: 10px 24px; border-radius: 10px; cursor: pointer; font-size: 0.85rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; border: 1px solid transparent; transition: all 0.4s; }
        .seg-btn:hover { background: rgba(255,255,255,0.5); }
        .seg-btn.active { transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.1); color: white; border-color: rgba(0,0,0,0.05); }
        .seg-btn[data-val="pendente"].active { background: var(--status-todo); }
        .seg-btn[data-val="andamento"].active { background: var(--warning); }
        .seg-btn[data-val="concluido"].active { background: var(--status-done); }
        
        .btn-save { background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; min-width: 150px; }
        .btn-save:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(15, 76, 129, 0.3); }
        .btn-save:disabled { background: #94a3b8; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-update-step { background: var(--warning); color: white; border: none; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; float: right; margin-top: 10px; }
        .confirm-box { background: white; padding: 30px; border-radius: 16px; text-align: center; max-width: 400px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.2); transform: scale(0.9); transition: 0.3s; }
        .modal-overlay.active .confirm-box { transform: scale(1); }
        .confirm-icon { width: 60px; height: 60px; background: #fef2f2; border-radius: 50%; color: var(--danger); display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; }
        .alert-icon { width: 60px; height: 60px; background: #fff7ed; border-radius: 50%; color: var(--warning); display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; }
        .confirm-title { font-size: 1.2rem; font-weight: 800; color: var(--text-main); margin-bottom: 10px; }
        .confirm-desc { font-size: 0.95rem; color: var(--text-light); margin-bottom: 25px; line-height: 1.5; }
        .confirm-actions { display: flex; gap: 10px; justify-content: center; }
        .btn-cancel { background: #f1f5f9; color: var(--text-main); border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-delete { background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); }
        .btn-delete:disabled { opacity: 0.7; cursor: wait; }
        .btn-ok { background: var(--primary); color: white; border: none; padding: 10px 30px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        @media (max-width: 900px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .span-2, .span-4 { grid-column: 1; }
            header { flex-direction: column; padding: 15px; }
            .header-actions { width: 100%; flex-direction: column; gap: 10px; margin-top: 10px; }
            .search-wrapper { width: 100%; }
            .search-input { width: 100%; opacity: 1; background: white; padding-left: 40px; }
            .filter-pills { width: 100%; overflow-x: auto; padding: 5px; -webkit-overflow-scrolling: touch; }
            .modal-wide { width: 100%; height: 100%; border-radius: 0; }
            .modal-body { grid-template-columns: 1fr; }
            .col-left { border-right: none; border-bottom: 1px solid #eee; padding: 25px; }
            .col-right { padding: 25px; }
            .modal-footer { flex-direction: column; gap: 15px; padding: 20px; }
            .status-segmented { width: 100%; }
            .seg-btn { flex: 1; padding: 10px; font-size: 0.75rem; }
            .btn-save { width: 100%; }
        }
    </style>
</head>
<body>
    
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-weight: 700; color: var(--primary);">Carregando Base de Dados...</div>
    </div>

    <header>
        <div class="logo-area">
            <h1><span class="brand-text">INTEGRA</span> <span class="brand-plus">+</span></h1>
        </div>
        
        <div class="header-actions">
            <div class="filter-pills">
                <button class="filter-btn active" onclick="setFilter('recentes', this)">Recentes</button>
                <button class="filter-btn" onclick="setFilter('antigos', this)">Antigos</button>
                <button class="filter-btn" onclick="setFilter('prioridade', this)">Prioridade</button>
                <button class="filter-btn" onclick="setFilter('unidade', this)">Unidade</button>
                <button class="filter-btn" onclick="setFilter('status', this)">Status</button>
            </div>

            <div class="search-wrapper">
                <input type="text" class="search-input" placeholder="Pesquisar..." onkeyup="filtrarCards(this.value)">
                <div class="search-icon-bg"><span class="material-icons-round">search</span></div>
            </div>

            <button class="btn-toggle-stats" onclick="toggleStats()" id="btnStats">
                <span class="material-icons-round">bar_chart</span><span style="font-size:0.9rem">Estatísticas</span>
            </button>

            <button class="btn-main-add" onclick="abrirModal()"><span class="material-icons-round">add_circle</span></button>
        </div>
    </header>

    <div class="stats-panel" id="statsPanel">
        <div class="dashboard-grid">
            <div class="chart-box"><div class="chart-title">Workflow (Geral)</div><div class="chart-container-fixed"><canvas id="chartStatus"></canvas></div></div>
            <div class="chart-box"><div class="chart-title">Performance de Prazos</div><div class="chart-container-fixed"><canvas id="chartPrazos"></canvas></div></div>
            <div class="chart-box span-2"><div class="chart-title">Ocorrências por Unidade</div><div class="chart-container-fixed"><canvas id="chartUnit"></canvas></div></div>
            <div class="chart-box span-4"><div class="chart-title">Ranking de Responsáveis (Top 5)</div><div class="chart-scroll-wrapper"><div class="chart-dynamic-height" id="respChartContainer"><canvas id="chartResp"></canvas></div></div></div>
        </div>
    </div>

    <div class="tabs-container">
        <div class="tab-btn active" onclick="mudarAba('ativos')" id="tab-ativos">Em Aberto <span class="tab-count" id="count-ativos">0</span></div>
        <div class="tab-btn" onclick="mudarAba('arquivados')" id="tab-arquivados">Arquivo / Resolvidos <span class="tab-count" id="count-arquivados">0</span></div>
    </div>

    <div class="grid" id="grid"></div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-wide">
            <div class="modal-top">
                <input type="text" id="inpTitle" class="title-input" placeholder="Digite o Título da Ocorrência">
                <input type="hidden" id="taskId">
                <button class="close-btn" onclick="fecharModal()"><span class="material-icons-round">close</span></button>
            </div>
            <div class="modal-body">
                <div class="col-left">
                    <span class="section-label">Configuração da Ocorrência</span>
                    <div class="meta-grid">
                        <div>
                            <label style="font-size:0.7rem; color:var(--text-light); font-weight:700;">UNIDADE</label>
                            <select id="inpUnit" class="styled-input" style="cursor:pointer; margin-top:5px;">
                                <option value="" disabled selected>Selecione...</option>
                                <option value="CER IV">CER IV</option>
                                <option value="Iputinga">Iputinga</option>
                                <option value="Boa Vista">Boa Vista</option>
                                <option value="Jaboatão">Jaboatão</option>
                                <option value="Salgueiro">Salgueiro</option>
                                <option value="Serra Talhada">Serra Talhada</option>
                                <option value="CFAV">CFAV</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:0.7rem; color:var(--text-light); font-weight:700;">PRIORIDADE</label>
                            <select id="inpPriority" class="styled-input" style="cursor:pointer; margin-top:5px;">
                                <option value="baixa">Baixa</option>
                                <option value="media">Média</option>
                                <option value="alta">Alta</option>
                            </select>
                        </div>
                    </div>

                    <span class="section-label">Origem da Demanda</span>
                    <input type="text" id="inpOrigin" class="styled-input" placeholder="Ex: E-mail da Diretoria, Reclamação..." style="margin-bottom:20px;">

                    <span class="section-label">Problema / Diagnóstico Detalhado</span>
                    <textarea id="inpProblem" class="styled-textarea" placeholder="Descreva aqui todos os detalhes do problema..."></textarea>
                    
                    <div style="height: 20px;"></div>
                    <div class="date-grid">
                        <div class="date-card"><label><span class="material-icons-round" style="font-size:14px">calendar_today</span> Data Início</label><input type="date" id="inpDateStart" class="date-input-clean"></div>
                        <div class="date-card"><label><span class="material-icons-round" style="font-size:14px">event_busy</span> Prazo Limite</label><input type="date" id="inpDateDue" class="date-input-clean"></div>
                    </div>
                    
                    <span class="section-label">Responsáveis</span>
                    <input type="text" id="inpResp" class="styled-input" placeholder="Nome dos responsáveis (separados por vírgula)">
                </div>
                <div class="col-right">
                    <span class="section-label" style="color:var(--primary)">Histórico de Execução</span>
                    <div class="timeline" id="timelineList"></div>
                    <div class="add-step-area" id="stepInputArea">
                        <input type="text" id="newStepDesc" class="styled-input" placeholder="Nova etapa (Ex: Peça comprada)">
                        <textarea id="newStepObs" class="step-obs-area" placeholder="Observações, valores, detalhes..."></textarea>
                        <button id="btnAddStepBtn" onclick="adicionarPasso()" style="margin-top:10px; background:var(--primary); color:white; border:none; padding:8px 20px; border-radius:6px; font-weight:600; cursor:pointer; float:right;">Adicionar Etapa</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="tentarDeletar()" style="background:none; border:none; color:var(--danger); font-weight:700; cursor:pointer; display:flex; gap:5px; align-items:center;"><span class="material-icons-round">delete_outline</span> Excluir</button>
                <div class="status-segmented">
                    <div class="seg-btn" data-val="pendente" onclick="setStatus(this)">A Fazer</div>
                    <div class="seg-btn" data-val="andamento" onclick="setStatus(this)">Andamento</div>
                    <div class="seg-btn" data-val="concluido" onclick="setStatus(this)">Concluído</div>
                </div>
                <input type="hidden" id="selectedStatus" value="pendente">
                <button class="btn-save" id="btnSalvarPrincipal" onclick="salvarTask()">Salvar Registro</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteModal" style="z-index:110">
        <div class="confirm-box">
            <div class="confirm-icon"><span class="material-icons-round" style="font-size:30px">delete_forever</span></div>
            <div class="confirm-title">Excluir Ocorrência?</div>
            <div class="confirm-desc">Tem certeza que deseja apagar este item permanentemente da planilha?</div>
            <div class="confirm-actions">
                <button class="btn-cancel" onclick="fecharDeleteModal()">Cancelar</button>
                <button class="btn-delete" onclick="confirmarExclusao()">Sim, Excluir</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="alertModal" style="z-index:120">
        <div class="confirm-box">
            <div class="alert-icon"><span class="material-icons-round" style="font-size:30px">priority_high</span></div>
            <div class="confirm-title">Atenção</div>
            <div class="confirm-desc" id="alertMsg">É necessário preencher o título da ocorrência para continuar.</div>
            <div class="confirm-actions">
                <button class="btn-ok" onclick="fecharAlertModal()">Entendi</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbx14_AlrGZopkVowA3BF2UypwJscVnJcz4HzYCMvZdSKOMog0tzDy0JklKBDpjE47EjDw/exec"; 
        
        let tasks = [];
        let tempSteps = [];
        let editingStepIndex = -1;
        let abaAtual = 'ativos';
        let draggedItemIndex = null;
        let termoBusca = "";
        let ordemAtual = "recentes"; 
        let isStatsOpen = false;

        Chart.defaults.font.family = 'Inter';
        Chart.defaults.color = '#64748b';
        let chartStatusInstance = null;
        let chartRespInstance = null;
        let chartUnitInstance = null;
        let chartPrazosInstance = null;

        const grid = document.getElementById('grid');
        const modal = document.getElementById('modalOverlay');
        const deleteModal = document.getElementById('deleteModal');
        const alertModal = document.getElementById('alertModal');
        const timelineList = document.getElementById('timelineList');
        const btnAddStep = document.getElementById('btnAddStepBtn');
        const tabAtivos = document.getElementById('tab-ativos');
        const tabArquivados = document.getElementById('tab-arquivados');
        const statsPanel = document.getElementById('statsPanel');
        const btnStats = document.getElementById('btnStats');
        const loadingOverlay = document.getElementById('loading-overlay');

        // NORMALIZADOR DE STATUS (O SEGREDO)
        function normalizarTexto(texto) {
            if (!texto) return "pendente";
            return texto.toString().toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        carregarDados();

        async function carregarDados(silencioso = false) {
            try {
                if(!silencioso && loadingOverlay) loadingOverlay.classList.remove('hidden');
                
                const response = await fetch(API_URL + "?v=" + Date.now());
                const text = await response.text();
                let dados;
                
                try { 
                    dados = JSON.parse(text); 
                } catch(e) { 
                    console.error("Erro JSON:", text);
                    if(loadingOverlay) loadingOverlay.classList.add('hidden');
                    return; 
                }
                
                // PROTEÇÃO: Se não vier um array (veio erro do Google), não trava o site
                if(!Array.isArray(dados)) {
                    console.error("Erro do Google Sheets:", dados);
                    if(loadingOverlay) loadingOverlay.classList.add('hidden');
                    return;
                }

                tasks = dados.map(t => {
                    // BLINDAGEM DE COLUNAS
                    const getKey = (keyName) => Object.keys(t).find(k => k.toLowerCase() === keyName.toLowerCase());

                    let dStart = t[getKey('datestart')] || t['Data Inicio'] || "";
                    let dDue = t[getKey('datedue')] || t['Data Prazo'] || "";
                    let st = t[getKey('status')] || "pendente"; 

                    return {
                        ...t, 
                        id: Number(t.id),
                        dateStart: dStart, 
                        dateDue: dDue,
                        status: st, 
                        steps: Array.isArray(t.steps) ? t.steps : [] 
                    }
                });
                
                renderGrid();
                if(isStatsOpen) atualizarGraficos();
            } catch (error) { console.error("Erro Fatal:", error); } 
            finally { 
                if(loadingOverlay) loadingOverlay.classList.add('hidden');
            }
        }

        function formatarDataSemFuso(dataStr) {
            if (!dataStr) return '--/--';
            let str = String(dataStr).trim();
            if(str.includes('T')) str = str.split('T')[0];
            if(str.includes('/')) return str; 
            if(str.includes('-')) {
                const partes = str.split('-');
                if(partes.length === 3) return `${partes[2]}/${partes[1]}/${partes[0]}`;
            }
            return str;
        }

        function dataParaInput(dataStr) {
            if (!dataStr) return "";
            let str = String(dataStr).trim();
            if(str.includes('T')) str = str.split('T')[0];
            if(str.includes('/')) {
                const partes = str.split('/');
                if(partes.length === 3) return `${partes[2]}-${partes[1]}-${partes[0]}`;
            }
            return str; 
        }

        function dataParaPlanilha(dataInput) {
            if (!dataInput) return "";
            const partes = dataInput.split('-');
            if(partes.length === 3) return `${partes[2]}/${partes[1]}/${partes[0]}`;
            return dataInput;
        }

        function toggleStats() {
            isStatsOpen = !isStatsOpen;
            if(isStatsOpen) { statsPanel.classList.add('open'); btnStats.classList.add('active'); setTimeout(atualizarGraficos, 300); } 
            else { statsPanel.classList.remove('open'); btnStats.classList.remove('active'); }
        }

        function atualizarGraficos() {
            if(!isStatsOpen) return;
            const counts = { pendente: 0, andamento: 0, concluido: 0 };
            const unitCounts = {}; const respMap = {};
            const hoje = new Date().toISOString().split('T')[0];
            let emDia = 0, atrasados = 0;

            tasks.forEach(t => {
                let st = normalizarTexto(t.status);
                if(st === 'concluido') counts.concluido++;
                else if(st === 'andamento') counts.andamento++;
                else counts.pendente++;

                let prazoUS = dataParaInput(t.dateDue);
                if(prazoUS) {
                    if(st !== 'concluido' && prazoUS < hoje) atrasados++; else emDia++;
                }
                const u = t.unit || 'Não Informada';
                unitCounts[u] = (unitCounts[u] || 0) + 1;
                const nomes = t.resp ? t.resp.split(',') : ['Não atribuído'];
                nomes.forEach(nome => {
                    const nRaw = nome.trim();
                    if(nRaw) { const nNorm = nRaw.charAt(0).toUpperCase() + nRaw.slice(1).toLowerCase(); respMap[nNorm] = (respMap[nNorm] || 0) + 1; }
                });
            });

            const ctxStatus = document.getElementById('chartStatus').getContext('2d');
            if(chartStatusInstance) chartStatusInstance.destroy();
            chartStatusInstance = new Chart(ctxStatus, { type: 'doughnut', data: { labels: ['A Fazer', 'Andamento', 'Concluído'], datasets: [{ data: [counts.pendente, counts.andamento, counts.concluido], backgroundColor: ['#475569', '#f59e0b', '#059669'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } });

            const ctxPrazos = document.getElementById('chartPrazos').getContext('2d');
            if(chartPrazosInstance) chartPrazosInstance.destroy();
            chartPrazosInstance = new Chart(ctxPrazos, { type: 'doughnut', data: { labels: ['No Prazo / Em dia', 'Atrasado'], datasets: [{ data: [emDia, atrasados], backgroundColor: ['#14b8a6', '#ef4444'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } });

            const ctxUnit = document.getElementById('chartUnit').getContext('2d');
            if(chartUnitInstance) chartUnitInstance.destroy();
            chartUnitInstance = new Chart(ctxUnit, { type: 'doughnut', data: { labels: Object.keys(unitCounts), datasets: [{ data: Object.values(unitCounts), backgroundColor: ['#0f4c81', '#00d2d3', '#5f27cd', '#ff9f43', '#ee5253', '#10ac84'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } });

            const sortedResp = Object.entries(respMap).sort((a,b) => b[1] - a[1]).slice(0, 5);
            document.getElementById('respChartContainer').style.height = '200px'; 
            const ctxResp = document.getElementById('chartResp').getContext('2d');
            if(chartRespInstance) chartRespInstance.destroy();
            chartRespInstance = new Chart(ctxResp, { type: 'bar', data: { labels: sortedResp.map(i=>i[0]), datasets: [{ label: 'Ocorrências', data: sortedResp.map(i=>i[1]), backgroundColor: '#0f4c81', borderRadius: 4, barPercentage: 0.6, maxBarThickness: 35 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } } });
        }

        function filtrarCards(valor) { termoBusca = valor.toLowerCase(); renderGrid(); }
        function setFilter(valor, btnElement) { ordemAtual = valor; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btnElement.classList.add('active'); renderGrid(); }
        
        function mudarAba(novaAba) {
            if(abaAtual === novaAba) return;
            abaAtual = novaAba;
            if(abaAtual === 'ativos') { tabAtivos.classList.add('active'); tabArquivados.classList.remove('active'); } 
            else { tabAtivos.classList.remove('active'); tabArquivados.classList.add('active'); }
            renderGrid();
        }

        function renderGrid() {
            grid.innerHTML = "";
            let filteredTasks = tasks.filter(t => {
                const matchBusca = t.title.toLowerCase().includes(termoBusca) || 
                                   t.resp.toLowerCase().includes(termoBusca) || 
                                   t.problem.toLowerCase().includes(termoBusca) ||
                                   (t.origin && t.origin.toLowerCase().includes(termoBusca)) ||
                                   (t.unit && t.unit.toLowerCase().includes(termoBusca));
                return matchBusca;
            });

            filteredTasks.sort((a, b) => {
                if(ordemAtual === 'recentes') return b.id - a.id;
                if(ordemAtual === 'antigos') return a.id - b.id;
                if(ordemAtual === 'prioridade') { const map = { 'alta': 3, 'media': 2, 'baixa': 1 }; return (map[b.priority] || 1) - (map[a.priority] || 1); }
                if(ordemAtual === 'unidade') { return (a.unit || 'z').localeCompare(b.unit || 'z'); }
                
                const stA = normalizarTexto(a.status);
                const stB = normalizarTexto(b.status);
                if(ordemAtual === 'status') { const map = {'pendente': 1, 'andamento': 2, 'concluido': 3}; return (map[stA] || 99) - (map[stB] || 99); }
                return 0;
            });

            document.getElementById('count-ativos').innerText = filteredTasks.filter(t => normalizarTexto(t.status) !== 'concluido').length;
            document.getElementById('count-arquivados').innerText = filteredTasks.filter(t => normalizarTexto(t.status) === 'concluido').length;

            const tarefasVisiveis = filteredTasks.filter(t => {
                const st = normalizarTexto(t.status);
                if(abaAtual === 'ativos') return st !== 'concluido';
                if(abaAtual === 'arquivados') return st === 'concluido';
            });

            if(tarefasVisiveis.length === 0) { grid.innerHTML = `<div class="empty-state">Nenhum registro encontrado.</div>`; return; }

            const hoje = new Date().toISOString().split('T')[0];

            tarefasVisiveis.forEach((task, index) => {
                if(!task.steps) task.steps = [];
                const stNormalized = normalizarTexto(task.status);

                let prazoUS = dataParaInput(task.dateDue);
                const hasDate = prazoUS && prazoUS.trim() !== "";
                let isLate = (hasDate && prazoUS < hoje && stNormalized !== 'concluido');
                let isConcluded = (stNormalized === 'concluido');
                let isOntime = (hasDate && !isLate && !isConcluded);
                
                const respArray = task.resp ? task.resp.split(',').map(s => s.trim()) : ['Não atribuído'];
                const respTags = respArray.map(r => `<span class="resp-tag">${r.charAt(0).toUpperCase() + r.slice(1).toLowerCase()}</span>`).join('');

                const dataInicio = formatarDataSemFuso(task.dateStart || "");
                const dataPrazo = formatarDataSemFuso(task.dateDue || "");
                
                let stInfo = { l: 'Indefinido', c: 'st-pendente' };
                if(stNormalized === 'pendente') stInfo = { l: 'A Fazer', c: 'st-pendente' };
                else if(stNormalized === 'andamento') stInfo = { l: 'Andamento', c: 'st-andamento' };
                else if(stNormalized === 'concluido') stInfo = { l: 'Concluído', c: 'st-concluido' };

                const unitText = task.unit || 'Sem Unidade';
                const originText = task.origin || 'Origem não informada';
                const prio = task.priority || 'baixa';
                const prioLabel = { 'alta': 'Alta', 'media': 'Média', 'baixa': 'Baixa' }[prio];
                const prioClass = { 'alta': 'p-alta', 'media': 'p-media', 'baixa': 'p-baixa' }[prio];
                const prioIcon = prio === 'alta' ? 'priority_high' : (prio === 'media' ? 'remove' : 'keyboard_arrow_down');
                
                let dateStatusHTML = '';
                if(isLate) dateStatusHTML = `<span class="date-pill late">Atrasado</span>`;
                else if(isOntime) dateStatusHTML = `<span class="date-pill ontime">Em dia</span>`;
                else if(!hasDate && !isConcluded) dateStatusHTML = `<span class="date-pill nodate">S/ Prazo</span>`;

                const card = document.createElement('div');
                let cardClasses = 'card';
                if(isLate) cardClasses += ' is-late';
                if(isConcluded) cardClasses += ' is-concluded';
                
                card.className = cardClasses;
                card.onclick = () => abrirModal(task.id);
                card.style.animationDelay = `${index * 0.05}s`;

                card.innerHTML = `
                    <div class="card-main">
                        <div class="card-header-top">
                            <div class="prio-badge ${prioClass}"><span class="material-icons-round" style="font-size:10px">${prioIcon}</span> ${prioLabel}</div>
                            <div class="status-text ${stInfo.c}"><div class="dot-status"></div> ${stInfo.l}</div>
                        </div>
                        <h3>${task.title}</h3>
                        <div class="card-origin-row"><span class="material-icons-round" style="font-size:16px; color:var(--primary)">history_edu</span> <span class="origin-text-content">${originText}</span></div>
                        <div class="card-meta">
                            <div class="meta-item"><span class="material-icons-round" style="font-size:16px">event</span> ${dataInicio}</div>
                            <div class="meta-item"><span class="material-icons-round" style="font-size:16px; color:${isLate ? 'var(--danger)' : 'inherit'}">event_busy</span> ${dataPrazo} ${dateStatusHTML}</div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="resp-container">${respTags}</div>
                        <div class="unit-clean"><span class="material-icons-round" style="font-size:14px">apartment</span> ${unitText}</div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function abrirModal(id = null) {
            const isEdit = id !== null;
            editingStepIndex = -1;
            resetStepInput();
            
            if(isEdit) {
                const t = tasks.find(x => x.id == id);
                if (!t) return;

                document.getElementById('taskId').value = t.id;
                document.getElementById('inpTitle').value = t.title || '';
                document.getElementById('inpUnit').value = t.unit || '';
                document.getElementById('inpPriority').value = t.priority || 'baixa';
                document.getElementById('inpOrigin').value = t.origin || '';
                document.getElementById('inpProblem').value = t.problem || '';
                document.getElementById('inpResp').value = t.resp || '';
                
                document.getElementById('inpDateStart').value = dataParaInput(t.dateStart);
                document.getElementById('inpDateDue').value = dataParaInput(t.dateDue);
                
                updateStatusUI(normalizarTexto(t.status) || 'pendente');
                tempSteps = [...(t.steps || [])];
            } else {
                const hojeISO = new Date().toISOString().split('T')[0];
                document.getElementById('taskId').value = '';
                document.getElementById('inpTitle').value = '';
                document.getElementById('inpUnit').value = ''; 
                document.getElementById('inpPriority').value = 'baixa';
                document.getElementById('inpOrigin').value = '';
                document.getElementById('inpProblem').value = '';
                document.getElementById('inpResp').value = '';
                document.getElementById('inpDateStart').value = hojeISO;
                document.getElementById('inpDateDue').value = '';
                updateStatusUI('pendente');
                tempSteps = [];
            }
            renderTimeline();
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function fecharModal() { modal.classList.remove('active'); setTimeout(() => modal.style.display = 'none', 300); }
        function tentarDeletar() { deleteModal.style.display = 'flex'; setTimeout(() => deleteModal.classList.add('active'), 10); }
        function fecharDeleteModal() { deleteModal.classList.remove('active'); setTimeout(() => deleteModal.style.display = 'none', 300); }
        function showCustomAlert(msg) { document.getElementById('alertMsg').innerText = msg; alertModal.style.display = 'flex'; setTimeout(() => alertModal.classList.add('active'), 10); }
        function fecharAlertModal() { alertModal.classList.remove('active'); setTimeout(() => alertModal.style.display = 'none', 300); }

        async function salvarTask() {
            try {
                const idExistente = document.getElementById('taskId').value;
                const title = document.getElementById('inpTitle').value;
                if(!title) return showCustomAlert("Por favor, digite o título da ocorrência.");

                const btnSalvar = document.getElementById('btnSalvarPrincipal');
                const textoOriginal = btnSalvar.innerHTML;
                btnSalvar.innerHTML = `<span class="material-icons-round" style="font-size:16px; animation: spin 1s linear infinite;">refresh</span> Salvando...`;
                btnSalvar.disabled = true;
                document.body.style.cursor = 'wait';
                
                const rawResp = document.getElementById('inpResp').value || "";
                const namesArray = rawResp.split(',').map(n => n.trim().charAt(0).toUpperCase() + n.trim().slice(1).toLowerCase()).filter(n => n.length > 0);
                const uniqueNames = [...new Set(namesArray)].join(', ');

                const taskData = {
                    id: idExistente ? parseInt(idExistente) : Date.now(),
                    title: title,
                    unit: document.getElementById('inpUnit').value,
                    priority: document.getElementById('inpPriority').value,
                    origin: document.getElementById('inpOrigin').value,
                    problem: document.getElementById('inpProblem').value,
                    resp: uniqueNames, 
                    dateStart: dataParaPlanilha(document.getElementById('inpDateStart').value),
                    dateDue: dataParaPlanilha(document.getElementById('inpDateDue').value),
                    status: document.getElementById('selectedStatus').value,
                    steps: tempSteps,
                    action: idExistente ? "update" : "create"
                };
            
                await fetch(API_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify(taskData)
                });

                if(idExistente) {
                    const idx = tasks.findIndex(t => t.id == taskData.id);
                    if(idx !== -1) tasks[idx] = taskData;
                } else {
                    tasks.push(taskData);
                }

                fecharModal();
                renderGrid();
                if(isStatsOpen) atualizarGraficos();
                
                setTimeout(() => carregarDados(true), 2000);

                btnSalvar.innerHTML = textoOriginal;
                btnSalvar.disabled = false;
                document.body.style.cursor = 'default';

            } catch (error) { 
                console.error(error); 
                alert("Ocorreu um erro ao salvar. Verifique sua conexão.");
                const btn = document.getElementById('btnSalvarPrincipal');
                if(btn) { btn.innerHTML = "Salvar Registro"; btn.disabled = false; }
                document.body.style.cursor = 'default';
            } 
        }

        async function confirmarExclusao() {
            const id = document.getElementById('taskId').value;
            const btnDel = document.querySelector('.btn-delete');
            const textoOriginal = btnDel.innerText;
            btnDel.innerText = "Excluindo...";
            btnDel.disabled = true;
            document.body.style.cursor = 'wait';

            try {
                await fetch(API_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify({ action: "delete", id: id })
                });

                tasks = tasks.filter(t => t.id != id); 
                fecharDeleteModal();
                fecharModal();
                renderGrid();
                if(isStatsOpen) atualizarGraficos();

                setTimeout(() => carregarDados(true), 2000);

            } catch(e) { console.error(e); } 
            finally {
                btnDel.innerText = textoOriginal;
                btnDel.disabled = false;
                document.body.style.cursor = 'default';
            }
        }

        function handleDragStart(e) { draggedItemIndex = +this.getAttribute('data-index'); this.classList.add('dragging'); timelineList.classList.add('is-dragging-active'); e.dataTransfer.effectAllowed = 'move'; }
        function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }
        function handleDragEnter(e) { if (this.getAttribute('data-index') != draggedItemIndex) { this.classList.add('drag-over-target'); } }
        function handleDragLeave(e) { this.classList.remove('drag-over-target'); }
        function handleDrop(e) { e.stopPropagation(); this.classList.remove('drag-over-target'); if (draggedItemIndex !== null) { const targetIndex = +this.getAttribute('data-index'); if (draggedItemIndex !== targetIndex) { const itemToMove = tempSteps[draggedItemIndex]; tempSteps.splice(draggedItemIndex, 1); tempSteps.splice(targetIndex, 0, itemToMove); renderTimeline(); } } return false; }
        function handleDragEnd(e) { this.classList.remove('dragging'); timelineList.classList.remove('is-dragging-active'); document.querySelectorAll('.timeline-item').forEach(item => item.classList.remove('drag-over-target')); draggedItemIndex = null; }

        function renderTimeline() {
            timelineList.innerHTML = "";
            tempSteps.forEach((step, idx) => {
                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.setAttribute('draggable', 'true');
                item.setAttribute('data-index', idx);
                item.addEventListener('dragstart', handleDragStart); item.addEventListener('dragover', handleDragOver); item.addEventListener('dragenter', handleDragEnter); item.addEventListener('dragleave', handleDragLeave); item.addEventListener('drop', handleDrop); item.addEventListener('dragend', handleDragEnd);
                item.innerHTML = `<div class="t-dot"></div><div class="t-bubble" title="Segure para arrastar"><div class="t-actions"><span class="material-icons-round t-btn-icon" onclick="prepararEdicao(${idx})" title="Editar">edit</span><span class="material-icons-round t-btn-icon del" onclick="removeStep(${idx})" title="Remover">close</span></div><div style="width:100%"><div style="font-weight:700; color:var(--text-main); padding-right:50px;">${step.desc}</div><div class="t-obs">${step.obs}</div></div></div>`;
                timelineList.appendChild(item);
            });
        }

        function prepararEdicao(idx) { const step = tempSteps[idx]; document.getElementById('newStepDesc').value = step.desc; document.getElementById('newStepObs').value = step.obs; editingStepIndex = idx; btnAddStep.innerText = "Atualizar Etapa"; btnAddStep.className = "btn-update-step"; document.getElementById('newStepDesc').focus(); }
        function adicionarPasso() { const desc = document.getElementById('newStepDesc').value; const obs = document.getElementById('newStepObs').value; if(!desc) return document.getElementById('newStepDesc').focus(); if (editingStepIndex > -1) { tempSteps[editingStepIndex] = { desc, obs }; editingStepIndex = -1; } else { tempSteps.push({ desc, obs }); } resetStepInput(); renderTimeline(); }
        function resetStepInput() { document.getElementById('newStepDesc').value = ''; document.getElementById('newStepObs').value = ''; btnAddStep.innerText = "Adicionar Etapa"; btnAddStep.className = ""; btnAddStep.style = "margin-top:10px; background:var(--primary); color:white; border:none; padding:8px 20px; border-radius:6px; font-weight:600; cursor:pointer; float:right;"; }
        function removeStep(idx) { tempSteps.splice(idx, 1); renderTimeline(); }
        function setStatus(el) { updateStatusUI(el.getAttribute('data-val')); }
        function updateStatusUI(val) { document.getElementById('selectedStatus').value = val; document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.seg-btn[data-val="${val}"]`).classList.add('active'); }

        modal.onclick = (e) => { if(e.target === modal) fecharModal() };
        deleteModal.onclick = (e) => { if(e.target === deleteModal) fecharDeleteModal() };
        alertModal.onclick = (e) => { if(e.target === alertModal) fecharAlertModal() };
    </script>
</body>
</html>